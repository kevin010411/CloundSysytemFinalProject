<!DOCTYPE html>
<head>
    <style>
        body {
            display: flex;
            flex-direction: column;
            align-items: center;
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
        }

        video {
            width: 560px;
            height: 315px;
            margin-bottom: 20px;
        }

        .controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .controls button {
            padding: 5px 10px;
            font-size: 16px;
            cursor: pointer;
        }

        .controls span {
            font-size: 16px;
        }

        .comment-section {
            width: 560px;
            margin-top: 20px;
        }

        .comment-section h3 {
            text-align: left;
            font-size: 18px;
            margin-bottom: 10px;
        }

        .comment-section form {
            display: flex;
            flex-direction: column;
            margin-bottom: 20px;
        }

        .comment-section textarea {
            width: 100%;
            height: 100px;
            margin-bottom: 10px;
            padding: 10px;
            font-size: 14px;
        }

        .comment-section button {
            align-self: flex-end;
            padding: 5px 15px;
            font-size: 14px;
            cursor: pointer;
        }

        .comments {
            list-style-type: none;
            padding: 0;
        }

        .comments li {
            border-bottom: 1px solid #ccc;
            padding: 10px 0;
        }

        #title {
            width: 560px;
            margin-bottom: 20px;
        }

        #commentsAbove {
            margin-top: 10px;
        }

        .comment {
            border-bottom: 1px solid #ccc;
            padding: 5px 0;
        }
    </style>
</head>
<body>
    <div id="title">
        <h3>{{video_data.title}}</h3>
    </div>

    <video id="movie" controls autoplay>
        <source src={{url_for("static",filename="video/"~video_data.video_name)}} type="video/mp4">
        Your browser does not support the video tag.
    </video>
    
    <div class="controls">
        <span id="watchCount">ËßÄÁúãÊ¨°Êï∏:{{video_data.watch_num}}</span>
        <button id="likeButton">üëç Like</button>
        <span id="likeCount">{{video_data.good_num}}</span>
        <button id="dislikeButton">üëé Dislike</button>
        <span id="dislikeCount">{{video_data.bad_num}}</span>
        <button id="coinButton">üí∞ Coin</button>
        <span id="coinCount">{{video_data.coin_num}}</span>
        <button id="shareButton">üöª Share</button>
        <span id="shareCount">{{video_data.share_num}}</span>
    </div>
    <br>
    <div>
        Tag: {{video_data.tag}}<br>
        <br>
        ÊèèËø∞: <br>
        <br>
        {{video_data.description}}
    </div>
    
    <div id="commentsAbove" class="comments"></div>
    
    <div class="comment-section">
        <h3>Comments</h3>
        <form id="commentForm">
            <textarea id="commentInput" placeholder="Add a comment..."></textarea>
            <button type="submit">Post</button>
        </form>
        <ul class="comments" id="commentsList"></ul>
    </div>

    <script>
        const likeButton = document.getElementById('likeButton');
        const dislikeButton = document.getElementById('dislikeButton');
        const coinButton = document.getElementById('coinButton');
        const shareButton = document.getElementById('shareButton');

        const videoId = {{ video_data.id }}; // ÂãïÊÖãÊèíÂÖ•ÂΩ±ÁâáÁöÑ ID
        const updateUrl = `/update/${videoId}`;

        const updateCount = async (action, element) => {
            try {
                const response = await fetch(updateUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ action }),
                });

                if (!response.ok) {
                    throw new Error('Failed to update');
                }

                const data = await response.json();
                if (action === 'like') {
                    document.getElementById('likeCount').textContent = data.good_num;
                } else if (action === 'dislike') {
                    document.getElementById('dislikeCount').textContent = data.bad_num;
                } else if (action === 'coin') {
                    document.getElementById('coinCount').textContent = data.coin_num;
                } else if (action === 'share') {
                    document.getElementById('shareCount').textContent = data.share_num;
                }
            } catch (error) {
                console.error('Error:', error);
            }
        };

        likeButton.addEventListener('click', () => updateCount('like'));
        dislikeButton.addEventListener('click', () => updateCount('dislike'));
        coinButton.addEventListener('click', () => updateCount('coin'));
        shareButton.addEventListener('click', () => updateCount('share'));

        const commentsList = document.getElementById('commentsList');

        // Âä†ËºâÁïôË®Ä
        async function loadComments() {
            const response = await fetch(`/api/comments/${videoId}`);
            const comments = await response.json();

            commentsList.innerHTML = '';
            renderComments(comments, commentsList);
        }

        // Ê∏≤ÊüìÂ∑¢ÁãÄÁïôË®Ä
        function renderComments(comments, container) {
            comments.forEach(comment => {
                const commentElement = document.createElement('li');
                commentElement.innerHTML = `
                    <div>
                        <p><strong>${comment.user_name}</strong>: ${comment.content}</p>
                        <button class="reply-button" data-id="${comment.id}">Reply</button>
                        <ul class="replies"></ul>
                    </div>
                `;
                container.appendChild(commentElement);

                const replyButton = commentElement.querySelector('.reply-button');
                const repliesContainer = commentElement.querySelector('.replies');

                replyButton.addEventListener('click', () => {
                    const replyInput = document.createElement('textarea');
                    replyInput.placeholder = 'Add a reply...';
                    const replySubmit = document.createElement('button');
                    replySubmit.textContent = 'Post Reply';

                    replySubmit.addEventListener('click', async () => {
                        const content = replyInput.value.trim();
                        if (content) {
                            await postComment(videoId, content, comment.id);
                            replyInput.remove();
                            replySubmit.remove();
                            loadComments(); // ÈáçÊñ∞Âä†ËºâÁïôË®Ä
                        }
                    });

                    commentElement.appendChild(replyInput);
                    commentElement.appendChild(replySubmit);
                });

                if (comment.replies) {
                    renderComments(comment.replies, repliesContainer);
                }
            });
        }

        // Êñ∞Â¢ûÁïôË®Ä
        async function postComment(videoId, content, parentId = null) {
            await fetch(`/api/comments/${videoId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ content, parent_id: parentId, user_name: 'Anonymous' }),
            });
        }

        // ÂàùÂßãÂåñ
        document.getElementById('commentForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const commentInput = document.getElementById('commentInput');
            const content = commentInput.value.trim();
            if (content) {
                await postComment(videoId, content);
                commentInput.value = '';
                loadComments();
            }
        });

        loadComments();
    </script>
</body>
